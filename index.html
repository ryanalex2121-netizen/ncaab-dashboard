<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI vs. The Market: NCAAB Value Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Lighter gray background */
        }
        .header-bg {
            background: linear-gradient(90deg, #1d4ed8, #3b82f6);
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .filter-nav button {
            transition: all 0.2s ease;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .filter-nav button.active,
        .filter-nav button:hover {
            color: #ffffff;
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .value-tag {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.8rem;
        }
        .value-spread {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .value-total {
            background-color: #fee2e2;
            color: #991b1b;
        }
        #modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-6 max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI vs. The Market</h1>
        <p class="text-lg text-gray-600">NCAAB Daily Value Finder</p>
    </header>

    <nav id="filter-nav" class="flex justify-center space-x-2 mb-6 max-w-7xl mx-auto">
        <button id="all-filter-btn" class="px-4 py-2 rounded-full font-medium text-sm active">All Max Value</button>
        <button id="spread-filter-btn" class="px-4 py-2 rounded-full font-medium text-sm">Spread Value</button>
        <button id="total-filter-btn" class="px-4 py-2 rounded-full font-medium text-sm">Total Value</button>
    </nav>

    <main id="game-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 max-w-7xl mx-auto">
        <!-- Game cards will be injected here by JavaScript -->
        <p class="text-gray-600 col-span-full text-center">Loading game data...</p>
    </main>

    <!-- Modal Structure -->
    <div id="modal-backdrop" class="fixed inset-0 z-40 hidden" onclick="hideModal()"></div>
    <div id="analysis-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 w-11/12 max-w-2xl bg-white rounded-lg shadow-2xl p-6 md:p-8 hidden">
        <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="hideModal()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4">AI Analysis</h3>
        <p id="modal-text" class="text-gray-700 whitespace-pre-line"></p>
    </div>

    <script>
        // --- Global variables ---
        let activeFilter = 'all';
        let allMergedData = []; // This will hold the master list of merged data

        document.addEventListener('DOMContentLoaded', () => {
            // This is the main function call.
            // It fetches from our serverless function, NOT API-Sports directly.
            fetchDataAndRender(); 
            
            setupFilters();
            document.getElementById('close-modal-btn').addEventListener('click', hideModal);
        });

        /**
         * Fetches data from our own serverless endpoint,
         * calculates value, and renders the cards.
         */
        async function fetchDataAndRender() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = `<p class="text-gray-600 col-span-full text-center">Fetching live market data...</p>`;

            try {
                // Fetch from our own Vercel function
                const response = await fetch('/api/get-games');
                
                if (!response.ok) {
                    // Try to get the JSON error message from our serverless function
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                const mergedGameData = await response.json();

                if (!mergedGameData || mergedGameData.length === 0) {
                     grid.innerHTML = `<p class="text-gray-400 col-span-full text-center">No matching games found. Your AI projections may be out of date. Check the Vercel logs to see today's game names.</p>`;
                     return;
                }
                
                // --- Step 2: Calculate Value ---
                // We move the value calculation here, to the client-side
                allMergedData = mergedGameData.map(g => {
                    if (!g.marketLine) {
                        return { ...g, spreadValue: -Infinity, totalValue: -Infinity, maxValue: -Infinity, maxValueSource: 'N/A' };
                    }
                    const projectedMargin = g.projectedScore.team1 - g.projectedScore.team2;
                    const projectedTotal = g.projectedScore.team1 + g.projectedScore.team2;
                    
                    const spreadValue = Math.abs(projectedMargin - (g.marketLine.spread * -1));
                    const totalValue = Math.abs(projectedTotal - g.marketLine.total);
                    
                    const maxValue = Math.max(spreadValue, totalValue);
                    const maxValueSource = maxValue === spreadValue ? 'Spread' : 'Total';

                    return {...g, spreadValue, totalValue, maxValue, maxValueSource};
                });
                
                // --- Step 3: Render ---
                sortAndRender(); // Initial render

            } catch (error) {
                console.error("Failed to fetch or render live data:", error);
                // --- !! NEW ERROR DISPLAY !! ---
                // This will now show the detailed error from the serverless function.
                grid.innerHTML = `<p class="text-red-600 col-span-full text-center">
                    <strong>Failed to load data:</strong> 
                    <span class="block mt-2 font-mono text-sm">${error.message}</span>
                </p>`;
            }
        }
        
        function setupFilters() {
            const filterNav = document.getElementById('filter-nav');

            filterNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    // Update active styles
                    if (filterNav.querySelector('button.active')) {
                        filterNav.querySelector('button.active').classList.remove('active');
                    }
                    e.target.classList.add('active');
                    
                    const filter = e.target.id.replace('-filter-btn', ''); // 'all', 'spread', 'total'
                    activeFilter = filter;
                    
                    sortAndRender(); // Call the new sort/render function
                }
            });
        }

        /**
         * New function to sort and render based on the active filter
         */
        function sortAndRender() {
            let sortedData = [...allMergedData]; // Use the global data
            
            if (activeFilter === 'spread') {
                sortedData.sort((a, b) => b.spreadValue - a.spreadValue);
            } else if (activeFilter === 'total') {
                sortedData.sort((a, b) => b.totalValue - a.totalValue);
            } else { // 'all'
                sortedData.sort((a, b) => b.maxValue - a.maxValue);
            }
            
            renderGameCards(sortedData);
        }

        function renderGameCards(games) {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = ''; // Clear the grid first

            if (games.length === 0) {
                 // This message is now more specific
                if (allMergedData.length > 0) {
                    grid.innerHTML = `<p class="text-gray-400 col-span-full text-center">No games match the current filter.</p>`;
                } else {
                    // This case should be handled by fetchDataAndRender, but as a fallback:
                    grid.innerHTML = `<p class="text-gray-400 col-span-full text-center">No games found.</p>`;
                }
                return;
            }

            games.forEach(game => {
                const card = document.createElement('div');
                card.className = 'card rounded-lg shadow-md overflow-hidden p-5 flex flex-col justify-between';
                
                let valueDisplay = '';
                if (game.maxValueSource === 'Spread') {
                    valueDisplay = `<span class="value-tag value-spread">SPREAD: ${game.spreadValue.toFixed(1)} PTS</span>`;
                } else if (game.maxValueSource === 'Total') {
                    valueDisplay = `<span class="value-tag value-total">TOTAL: ${game.totalValue.toFixed(1)} PTS</span>`;
                } else {
                     valueDisplay = `<span class="value-tag bg-gray-200 text-gray-700">No Value</span>`;
                }

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <h2 class="text-xl font-semibold text-gray-800">${game.game}</h2>
                            <div class="text-right flex-shrink-0 ml-2">
                                ${valueDisplay}
                            </div>
                        </div>

                        <div class="mb-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">AI Projection:</span>
                                <span class="font-medium text-gray-900">${game.projectedScore.team1} - ${game.projectedScore.team2}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Market Spread:</span>
                                <span class="font-medium text-gray-900">${game.marketLine.spread}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Market Total:</span>
                                <span class="font-medium text-gray-900">${game.marketLine.total}</span>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-3 space-y-2">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">AI Pick (Spread):</span>
                                <span class="font-semibold text-blue-700">${game.aiPicks.spread}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">AI Pick (Total):</span>
                                <span class="font-semibold text-blue-700">${game.aiPicks.total}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="w-full mt-4 px-4 py-2 bg-gray-100 text-gray-700 font-medium text-sm rounded-md hover:bg-gray-200 transition" onclick="showModal('${game.id}')">
                        View AI Analysis
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        function showModal(gameId) {
            // This needs to find the game in the global data
            const game = allMergedData.find(g => g.id.toString() === gameId);
            if (!game) return;

            document.getElementById('modal-title').textContent = `AI Analysis: ${game.game}`;
            document.getElementById('modal-text').textContent = game.analysis;

            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('analysis-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('analysis-modal').classList.add('hidden');
        }

    </script>

</body>
</html>

